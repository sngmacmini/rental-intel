<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - Rent Trend</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
    <style>
        :root { 
            --bg-dark: #0a0a0f; 
            --bg-card: #1a1a24; 
            --primary: #467fcf; 
            --primary-light: #5a8fd4; 
            --text: #ffffff; 
            --text-muted: #71717a; 
            --border: #2a2a3a; 
            --accent: #22c55e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        
        /* Navigation */
        .main-nav { 
            background: linear-gradient(135deg, #0e2230 0%, #1a1a24 100%); 
            border-bottom: 1px solid rgba(70, 127, 207, 0.2); 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
        }
        .nav-container { 
            max-width: 1440px; margin: 0 auto; padding: 0 40px; 
            display: flex; align-items: center; justify-content: space-between; height: 72px; 
        }
        .nav-brand { 
            display: flex; align-items: center; gap: 12px; 
            text-decoration: none; font-size: 24px; font-weight: 700; color: var(--primary); 
        }
        .nav-menu { display: flex; gap: 4px; }
        .nav-link { 
            display: flex; align-items: center; gap: 8px; 
            padding: 10px 20px; border-radius: 12px; 
            color: var(--text-muted); text-decoration: none; 
            font-weight: 500; font-size: 15px; transition: all 0.3s; 
        }
        .nav-link:hover { background: rgba(70, 127, 207, 0.1); color: #fff; }
        .nav-link.active { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: #fff; box-shadow: 0 4px 15px rgba(70, 127, 207, 0.3); 
        }
        
        /* Layout */
        .map-wrapper { 
            position: fixed; top: 72px; left: 0; right: 0; bottom: 0; 
            display: flex; 
        }
        
        /* Sidebar */
        .sidebar { 
            width: 380px; background: var(--bg-card); 
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header { 
            padding: 20px; border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(70, 127, 207, 0.1), transparent);
        }
        .sidebar-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .sidebar-subtitle { font-size: 13px; color: var(--text-muted); }
        
        /* Search Box */
        .search-container { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .search-box { 
            position: relative; 
        }
        .search-input { 
            width: 100%; padding: 12px 16px 12px 44px; 
            background: var(--bg-dark); border: 1px solid var(--border); 
            border-radius: 12px; color: var(--text); font-size: 14px;
            font-family: 'Inter', sans-serif;
        }
        .search-input:focus { 
            outline: none; border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(70, 127, 207, 0.1);
        }
        .search-icon { 
            position: absolute; left: 16px; top: 50%; 
            transform: translateY(-50%); color: var(--text-muted); 
        }
        
        /* Filter Section */
        .filter-section { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .filter-label { 
            font-size: 11px; font-weight: 600; color: var(--text-muted); 
            text-transform: uppercase; margin-bottom: 12px; display: block;
        }
        .filter-row { 
            display: flex; gap: 8px; margin-bottom: 12px;
        }
        .filter-select { 
            flex: 1; padding: 10px; background: var(--bg-dark); 
            border: 1px solid var(--border); border-radius: 8px; 
            color: var(--text); font-size: 13px;
        }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        
        /* Price Range */
        .price-range { 
            display: flex; align-items: center; gap: 8px; margin-top: 12px;
        }
        .price-input { 
            flex: 1; padding: 10px; background: var(--bg-dark); 
            border: 1px solid var(--border); border-radius: 8px; 
            color: var(--text); font-size: 13px; text-align: center;
        }
        
        /* Results List */
        .results-container { 
            flex: 1; overflow-y: auto; padding: 0;
        }
        .result-count { 
            padding: 12px 20px; font-size: 13px; color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }
        .result-item { 
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.2s;
        }
        .result-item:hover { 
            background: rgba(70, 127, 207, 0.05);
        }
        .result-item.active { 
            background: rgba(70, 127, 207, 0.1); 
            border-left: 3px solid var(--primary);
        }
        .result-address { 
            font-size: 14px; font-weight: 600; margin-bottom: 4px;
        }
        .result-location { 
            font-size: 12px; color: var(--text-muted); margin-bottom: 8px;
        }
        .result-details { 
            display: flex; gap: 12px; align-items: center;
        }
        .result-price { 
            font-size: 16px; font-weight: 700; color: var(--accent);
        }
        .result-badge { 
            font-size: 11px; padding: 3px 8px; border-radius: 4px;
            background: rgba(70, 127, 207, 0.1); color: var(--primary);
        }
        
        /* Map Area */
        .map-container { 
            flex: 1; position: relative; 
        }
        #map { 
            width: 100%; height: 100%; 
        }
        
        /* Map Popup */
        .map-popup { 
            font-family: 'Inter', sans-serif; min-width: 200px;
        }
        .popup-title { 
            font-size: 14px; font-weight: 700; margin-bottom: 4px;
        }
        .popup-price { 
            font-size: 18px; font-weight: 700; color: var(--accent);
            margin-bottom: 8px;
        }
        .popup-details { 
            font-size: 12px; color: var(--text-muted);
            line-height: 1.6;
        }
        
        /* Stats Overlay */
        .stats-overlay { 
            position: absolute; top: 20px; right: 20px; 
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; z-index: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .stats-title { 
            font-size: 12px; color: var(--text-muted); margin-bottom: 8px;
        }
        .stats-value { 
            font-size: 24px; font-weight: 700; color: var(--primary);
        }
        .stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-muted); }
        .stat-number { font-size: 16px; font-weight: 600; }
        
        /* Loading */
        .loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .loading-spinner { 
            width: 40px; height: 40px; border: 3px solid var(--border); 
            border-top-color: var(--primary); border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 768px) { 
            .sidebar { width: 100%; position: absolute; bottom: 0; top: auto; height: 50vh; }
            .map-wrapper { flex-direction: column; }
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">üèòÔ∏è Rent Trend</a>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">üìä Dashboard</a>
                <a href="search.html" class="nav-link">üîç Search</a>
                <a href="map.html" class="nav-link active">üó∫Ô∏è Map</a>
            </div>
        </div>
    </nav>
    
    <div class="map-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">üèòÔ∏è Property Map</div>
                <div class="sidebar-subtitle">10M+ properties nationwide</div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search city, ZIP, or address..." 
                           oninput="handleSearch()">
                </div>
            </div>
            
            <div class="filter-section">
                <span class="filter-label">Quick Filters</span>
                <div class="filter-row">
                    <select class="filter-select" id="stateFilter" onchange="filterProperties()">
                        <option value="">All States</option>
                        <option value="CA">California</option>
                        <option value="NY">New York</option>
                        <option value="TX">Texas</option>
                        <option value="FL">Florida</option>
                    </select>
                    <select class="filter-select" id="typeFilter" onchange="filterProperties()">
                        <option value="">All Types</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="condo">Condo</option>
                    </select>
                </div>
                <span class="filter-label">Price Range</span>
                <div class="price-range">
                    <input type="number" class="price-input" id="minPrice" placeholder="Min" value="500">
                    <span>-</span>
                    <input type="number" class="price-input" id="maxPrice" placeholder="Max" value="10000">
                </div>
            </div>
            
            <div class="results-container" id="resultsContainer">
                <div class="result-count">Loading properties...</div>
            </div>
        </div>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <div class="stats-overlay">
                <div class="stats-title">Properties on Map</div>
                <div class="stats-value" id="visibleCount">-</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Avg Rent</div>
                        <div class="stat-number" id="avgRent">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Median</div>
                        <div class="stat-number" id="medianRent">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map', { 
            zoomControl: false,
            attributionControl: false
        }).setView([39.8283, -98.5795], 4); // Center on US
        
        // Add zoom control to bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        // Dark themed tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Property data (will be loaded from API)
        let allProperties = [];
        let markers = [];
        const markersLayer = L.layerGroup().addTo(map);
        
        // Color scale for rent prices
        function getPriceColor(rent) {
            if (rent < 1000) return '#22c55e';
            if (rent < 2000) return '#467fcf';
            if (rent < 3000) return '#a855f7';
            return '#ef4444';
        }
        
        // Create custom marker
        function createMarker(property) {
            const color = getPriceColor(property.rent);
            const size = property.priceCategory === 'high' ? 12 : 8;
            
            return L.circleMarker([property.lat, property.lng], {
                radius: size,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.6
            });
        }
        
        // Load properties from API
        async function loadProperties() {
            try {
                // Try to fetch from API
                const response = await fetch('https://buzzthat.net/rent-trend/api-search.php?limit=500');
                const data = await response.json();
                
                if (data.success && data.properties) {
                    // Add sample coordinates (in real app, these come from database)
                    allProperties = data.properties.map((p, i) => ({
                        ...p,
                        lat: 37.7749 + (Math.random() - 0.5) * 2, // Demo coordinates
                        lng: -122.4194 + (Math.random() - 0.5) * 2,
                        priceCategory: p.rent > 3000 ? 'high' : p.rent > 1500 ? 'medium' : 'low'
                    }));
                    
                    renderProperties(allProperties);
                    updateStats(allProperties);
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                showSampleData();
            }
        }
        
        // Demo data for preview
        function showSampleData() {
            const sampleData = [
                { address: '123 Main St, San Francisco', city: 'San Francisco', state: 'CA', rent: 3500, bedrooms: 2, type: 'apartment', lat: 37.7749, lng: -122.4194 },
                { address: '456 Oak Ave, Los Angeles', city: 'Los Angeles', state: 'CA', rent: 2800, bedrooms: 2, type: 'apartment', lat: 34.0522, lng: -118.2437 },
                { address: '789 Pine St, Seattle', city: 'Seattle', state: 'WA', rent: 2400, bedrooms: 1, type: 'apartment', lat: 47.6062, lng: -122.3321 },
                { address: '321 Elm St, Austin', city: 'Austin', state: 'TX', rent: 1800, bedrooms: 2, type: 'house', lat: 30.2672, lng: -97.7431 },
                { address: '654 Maple Dr, Denver', city: 'Denver', state: 'CO', rent: 2100, bedrooms: 2, type: 'apartment', lat: 39.7392, lng: -104.9903 },
                { address: '987 Cedar Ln, Boston', city: 'Boston', state: 'MA', rent: 3200, bedrooms: 1, type: 'condo', lat: 42.3601, lng: -71.0589 },
                { address: '147 Birch St, Miami', city: 'Miami', state: 'FL', rent: 2600, bedrooms: 2, type: 'apartment', lat: 25.7617, lng: -80.1918 },
                { address: '258 Willow Ave, Chicago', city: 'Chicago', state: 'IL', rent: 1900, bedrooms: 2, type: 'apartment', lat: 41.8781, lng: -87.6298 },
            ];
            
            allProperties = sampleData;
            renderProperties(sampleData);
            updateStats(sampleData);
        }
        
        // Render markers
        function renderProperties(properties) {
            markersLayer.clearLayers();
            markers = [];
            
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="result-count">Showing ${properties.length} properties</div>`;
            
            properties.forEach((property, index) => {
                const marker = createMarker(property);
                
                const popup = `
                    <div class="map-popup">
                        <div class="popup-title">${property.city}, ${property.state}</div>
                        <div class="popup-price">$${property.rent.toLocaleString()}/mo</div>
                        <div class="popup-details">
                            ${property.bedrooms}BR | ${property.type || 'Apartment'}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popup);
                marker.on('click', () => highlightProperty(index));
                markersLayer.addLayer(marker);
                markers.push(marker);
                
                // Add to sidebar list
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <div class="result-address">${property.city}, ${property.state}</div>
                    <div class="result-location">${property.type || 'Apartment'}</div>
                    <div class="result-details">
                        <span class="result-price">$${property.rent.toLocaleString()}</span>
                        <span class="result-badge">${property.bedrooms} BR</span>
                    </div>
                `;
                item.onclick = () => {
                    map.setView([property.lat, property.lng], 14);
                    marker.openPopup();
                    highlightProperty(index);
                };
                container.appendChild(item);
            });
        }
        
        // Update stats
        function updateStats(properties) {
            document.getElementById('visibleCount').textContent = properties.length;
            
            if (properties.length > 0) {
                const rents = properties.map(p => p.rent);
                const avg = Math.round(rents.reduce((a, b) => a + b, 0) / rents.length);
                const median = rents.sort((a, b) => a - b)[Math.floor(rents.length / 2)];
                
                document.getElementById('avgRent').textContent = `$${avg.toLocaleString()}`;
                document.getElementById('medianRent').textContent = `$${median.toLocaleString()}`;
            }
        }
        
        // Highlight property in sidebar
        function highlightProperty(index) {
            document.querySelectorAll('.result-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }
        
        // Search handler
        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const stateFilter = document.getElementById('stateFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || 99999;
            
            const filtered = allProperties.filter(p => {
                const matchesSearch = !term || 
                    p.city.toLowerCase().includes(term) ||
                    p.state.toLowerCase().includes(term) ||
                    (p.zip && p.zip.includes(term));
                
                const matchesState = !stateFilter || p.state === stateFilter;
                const matchesType = !typeFilter || p.property_type === typeFilter;
                const matchesPrice = p.rent >= minPrice && p.rent <= maxPrice;
                
                return matchesSearch && matchesState && matchesType && matchesPrice;
            });
            
            renderProperties(filtered);
            updateStats(filtered);
            
            // If search matches a city, zoom to it
            if (term && filtered.length > 0) {
                const first = filtered[0];
                map.setView([first.lat, first.lng], 10);
            }
        }
        
        function filterProperties() {
            handleSearch();
        }
        
        // Geocoder control
        L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Search locations...",
            position: 'topleft'
        }).on('markgeocode', function(e) {
            map.fitBounds(e.geocode.bbox);
        }).addTo(map);
        
        // Load data on init
        loadProperties();
        
        // Update on map move
        map.on('moveend', () => {
            const bounds = map.getBounds();
            const visible = allProperties.filter(p => 
                bounds.contains([p.lat, p.lng])
            );
            updateStats(visible);
        });
    </script>
</body>
</html>
